2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台

技术剖析：海莲花OceanLotus Encryptor样本分析

比尔.盖茨 2015-06-08 +15 共545112人围观 ，发现 37 个不明物体 安全报告 系统安全

前言

上周，360发布了海莲花的报告，数据收集，分析，解释，加工方面很能让人折服，但是看了其对所谓OceanLotus Encryptor样本的分析，和我自

观查到的，我觉得有些地方描述的不正确，而且其对病毒攻击流程的分析语焉不详——一个APT攻击报告不能详细说明其攻击流程，其他数据分析的

好我觉得都是没有说服力。

很多地方看似是语法错误导致的，其实是其并没有完全分析清楚攻击流程所导致的，比如 :

 

另外关于64位强密匙绕过杀软，其实质就是OceanLotus Encryptor 在创建进程时候的用到的一个64bytes的随机数，并没有什么其他的作用。还有

点释放的同名doc不是木马本身释放的，而是由其子进程解密母体文件，然后覆盖母体文件的所产生的。

综述

该病毒我首次注意到是今年4月初，时就觉得这个病毒非同一般，但是却没有深入的去分析，直到看到360的报告，我觉得写的很模糊，所以就详细

析了下。该样本所采用的技并不是说很复杂，但是各种技巧的组合还是很有杀伤力的，很好的绕过了杀软的检测，具有很强的隐蔽性，而且从代码逻

与攻击流程来看，该病毒绝对不是脚本小子，freshman所能写的。关于是不是专门针对中国的APT攻击，直到我分析完该样本，我觉得这应该不是

门针对中国大陆的APT攻击，原因有两点:

1、在其释放的文件中，有一个%appdata%/tencent/qq.exe的文件。该文件文件信息伪造为国际版qq.exe 如下图，

https://www.freebuf.com/articles/system/69356.html 1/13



2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台

2、在核心功能组建中，bundle.rdb会创建这样一个路径用于存放从服务器下载的其他攻击组件

 

如果是专门针对大陆的APT攻击，未免有点牵强。因为大陆很少会用到yahoo，而且qq政府工作人员也不会去用国际版，就算有那也很少。如果说是

APT攻击人员的失误，那么这这两点将是致命性的错误，会造成攻击失败。

综上我觉得如果说非要说是APT攻击，那么该攻击要么是针对驻外大使馆，或者海外中国企业的职工。qq用于自己使用,yahoo 则应该用于与当地人

民，工作交流使用，这样就能说的通了。

当然这只是我的推断，代表个人意见，如有不对勿喷。

攻击流程

2.1 攻击流程

该样本攻击流程分为三个阶段:第一阶段为释放，总共释放了两个文件%appata%tencent/qq.exe,%appdata/tencent/plugin/

Com.Tencnt.DirectShow/bundle.rdb。第二阶段注入代码到傀儡进程中让其加载核心功能组建bundle.rdb。第三阶段为核心功能组件，负责收集被

染系统信息，执行远程命令，并与服务器通信上传这些信息

。

 

 

https://www.freebuf.com/articles/system/69356.html 2/13



2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台

过程解释：

1.恶意电子邮件附件中包含Oceanlotus 
2.在%TEMP%中自拷贝自身 
3.释放同名白doc文件，释放下一阶段执行体qq.exe与核心功能组建bundle.rdb文件 
4.qq.exe运行之后注入代码到傀儡进程中 
5.傀儡进程加载bundle.rdb 
6.收集账号信息 
7.上传被感染机器信息到服务器，获取服务器指令

3.1dropper技术细节

Dropper，即360命名的OceanLotus Encryptor运行之后，首先会在%temp%中自释放一个副本，然后创建一个自进程，该进程命令行为%temp%

[random].tmp  –help[parentpath] [0-9a-f]{64} .

然后结束进程。子进程创建之后，先获取filepath路径，即母体的路径，然后读取母体id为65的资源数据，并解密，随后覆盖原文件，释放doc文档

之后会检测是否运行在虚拟机里，检测完之后便会解密数据释放qq.exe,与bundle.rdb，注册mspaint键值，建立计划任务，创建qq.exe进程，结束运

行。 

3.1.1 判断运行参数，以判断自身是否为母体的子进程。这样是为了确保正确释放doc文件。

3.1.2然后接下来获取资源节数据并解密资源节id为65的资源，即为doc文件内容。

3.1.3.检测是否运行自虚拟机中，如果是则结束运行。

通过这段指令，就可以检测运行环境是否在vmware里,该反虚拟机技术为公开的vmware 与客户机之间会话用的一段指令序列。

反虚拟机的手段其实有很多，但是选择这种方式本人认为：一是相对检测注册表,进程名可靠性比较高,更加通用，二是这样子会更加的隐蔽，因为检

注册表，与进程名很容易被分析人员识别出来，而且代码量会大.

3.1.3接下来是对解密自身数据，为释放%appdata%/Tencent/qq.exe 与%appdata% Tencent /plugin/Com.Tencnt.DirectShow/bundle.rdb 做准

备，值得注意的是解密数据不是整体存放的，而是分块解密，这样做是为了对抗杀毒软件， 扰乱分析人员的深入分析，其中解密算法相当复杂，下

https://www.freebuf.com/articles/system/69356.html 3/13



2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台
为解密流程一部分：

3.1.4 解密之后设置注册表，伪装为mspaint的注册表信息，分别设置

HKCU/SOFTWARE/mspaint 值为bundle.rdb的路径。 
HKLM/SOFTWARE/mspaint 值为qq.exe的路径。

3.1.5将qq.exe 加入计划任务

每过十五分钟启动一次%appdata%/Tencent/qq.exe

 

3.2 %appdata%/Tencent/qq.exe细节

3.2.1.该进程启动方式为计划任务创建的，运行之后首先把遍历是存在msiexec.exe

 %appdata%/Tencent/qq.exe 进程，如果存在则不运行。

3.2.2．查看注册表，查找注册表键值

HKCU\SOFTWARE\Microsoft\mspaint\  
HKLM\SOFTWARE\Microsoft\mspaint\

其中这两个键的键值为dropper创建的，并且其值分别为Bundle.rdb的路径与qq.exe的路径，如果查找成功则继续执行，不成功则结束进程。

3.2.3.遍历进程查看其用户是否为administator，如果是则遍历其模块，如果模块中存在bundle.rdb 则结束运行。

3.2.4遍历进程如果存在以下hash，则进行相应的操作

Hash算法的C代码如下：

https://www.freebuf.com/articles/system/69356.html 4/13



2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台

 

其中CRCkey，存在于%appdata%/Tencent/qq.exe本身，位于文件偏移0×1016134处

3.2.5 判断进程参数看其参数是否为 “rundll32.exe /m”

如果是则依次判断是否存在文件syswow64/msiexec.exe，system32/msiexec.exe, Program Files\Internet Explorer\iexplore.exe, Program File

(x86)\Internet Explorer\ielowutil.exe如果存在以上四个文件之一，则创建进程，为后面注入做准备。(本报告以msiexec.exe为例)。

其伪代码如下:

3.2.6创建完msiexec.exe后,遍历进程列表中的进程的所有线程，找到进程id为msiexec.exe的进程，挂起该进程的所有线程。为载入msiexec.exe做

备。

 

https://www.freebuf.com/articles/system/69356.html 5/13



2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台

 

3.2.7挂起所有线程之后，随后是注入代码到msiexec.exe.首先将bundle.rdb路径写入，如图所示

 

然后，获取LoadLibrayW,RtlGetLasterror,Sleep,ExitProcess地址后，注入shellcode其实现的功能是，载入bundle.rdb模块，其注入的代码如图:

 

当其注入完毕以后就恢复线程运行。这样qq.exe就完成了自己的任务。总结下qq.exe的最终目的主要是注入上面的代码到msiexec.exe 。但是该病毒

相对平时见到的简单木马确实很不同寻常，相对来说过程复杂，功能全面，而且代码很稳健，而且这一步骤起着承前启后的作用。

3.3 Bundle.rdb分析

Bundle.rdb是一个动态库，为其核心功能组建，其相当于一个云配置客户端， 内部并没有多少恶意行为痕迹，只负责请求，接收，处理服务器端的

息(但是由于我拿到的样本ip失效，所以看不到与服务端的通信)并且收集被感染系统的信息，相对来说代码也比前两个阶段的代码复杂，解密过程极

复杂，有一些是为了对抗杀软特征查杀的技巧，但是也相对比较简单。

https://www.freebuf.com/articles/system/69356.html 6/13



2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台

 

Bundle.rdb实现的功能有与C&C 通信，获取服务端指令或者下载其他组建，但是由于ip失效，所以看不到下一步的操作。

3.3.1  随机获取 zone.mizove.com ,sin04s01.listpaz.com active.soariz.com其中一个的的ip，然后与之建立连接，进行通信。

3.3.2 获取以下数据

注册表信息：

software\Microsoft\Windows NT\CurrentVersion\ime 
SOFTWARE\DESCRIPTION\System\CentralProcessor 
Software\ATI Technologies\Install\South Bridge\ATI_AHCI_RAID 
HARDWARE\DEVICEMAP\Scsi\Scsi Port 2\Scsi Bus 1\Target Id 0\Logical Unit Id 0

还有硬盘信息，用户名信息等这里就不一一列举了。 

3.3.3 从服务器中下载其他组建到一下路径，,并伪装成白文件。

%appdata%\Yahoo!\Messenger\Martha\cacheinfo.db 
%appdata%\Mozilla\statistics.db

后记

总的来说，病毒作者是选择了很巧妙地方法，由于功能分散在不同文件中，阶段行的执行，其中%appdata%tencent/qq.exe因为填充垃圾数据，对

了云查杀，巧妙地利用了正常程序的路径来存放自身，其留在被感染机器上的痕迹很小，这样的免杀效果很好，而不是单单加个壳，因为加壳恰恰会

起杀软与分析人员的注意。

*作者：比尔.盖茨，转载须注明来自FreeBuf黑客与极客（FreeBuf.COM）

上一篇：百度卫士U盘“附送”的木马分析

下一篇：开源HIDS-OSSEC使用实例2：使用联动功能阻断cc攻击

这些评论亮了

12345 回复

@ 观察员  你就是在这里胡搅蛮缠，混淆概念而已. 上次你在另一篇文章里咄咄逼人的“教做人”。现在你为啥会不解了呢？ 我这次把你上次的评论贴出来，看看你多么的“恼羞成

怒的":
 

观察员 (1级) 2015-06-03 回复 

@ selinux 

@上周360发布了一篇关于名为"海莲花"的分析报告，当时觉得碉堡了。然后我就很好奇——"海莲花"和"蓝莲花"啥关系，许巍干的?
 

1：请查一查莲花是什么花 在你的脑子里 一提到莲花就是蓝莲花。。。。 脑子锈逗，无知无畏吧。
 

2：技术复用就可以定性一样么 ？那请问APT1报告里面提到了 nc、pwddump等工具你咋不说APT1报告是恶意黑客工具通报呢？（哦忘问了，你知道啥是APT不，要不要给你

科普一下？）
 

3：请问你google给的链接哪一个串是能对应上的？请吹牛乱喷之前先打打草稿再来？
 

4：感染量大就不是APT么？请先回去好好看看desert falcons、Carbanak_APT、Equation这些APT报告中给出的感染量，然后再说话。
 

哎 不得不说现在年轻人的浮躁啊。。。。。 读懂人家360的报告再说吧 ..

亮了(12

已有 37 条评论

https://www.freebuf.com/articles/system/69356.html 7/13



2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台

drakan  (2级)  2015-06-08 1楼 回复

比尔你好

亮了 (

Hay  2015-06-08 2楼 回复

已阅，前排支持
亮了 (

mubiaofr  (1级)  2015-06-08 3楼 回复

啪啪啪……………

亮了

Smartizan  (1级)  2015-06-08 4楼 回复

分析的很好，就是C代码也有语法错误
亮了 (

夜尽天明  (6级) 千秋邈矣独留我，百战归来再读书  2015-06-08 5楼 回复

比尔盖茨都分析海莲花了，@马云你准备什么时候下手？
亮了 (

selinux  (1级)  2015-06-08 6楼 回复

有来！！看来没完没鸟了，希望360发声一下，给大家一个了断吧。
亮了 (

小杰哥  (1级)  2015-06-08 7楼 回复

分析的真心牛逼！
亮了 (

观察员  (1级)  2015-06-08 8楼 回复

OceanLotus是一个组织。但是我就纳闷了：恶意电子邮件附件怎么会包含一个APT组织呢？
  

把一个APT组织rar打包压缩添加附件么？你用的啥邮件客户端，还可以把一个APT组织做成附件？不解。。。。。求解释。。。难道楼主发明了新的攻击套路？
亮了 (

12345  2015-06-08 回

@ 观察员    你就是在这里胡搅蛮缠，混淆概念而已. 上次你在另一篇文章里咄咄逼人的“教做人”。现在你为啥会不解了呢？ 我这次把你上次的评论贴出来，看看你多么的“恼羞成怒的"
 
观察员    (1级)   2015-06-03     回复
  

@ selinux
  

@上周360发布了一篇关于名为"海莲花"的分析报告，当时觉得碉堡了。然后我就很好奇——"海莲花"和"蓝莲花"啥关系，许巍干的?
  

1：请查一查莲花是什么花 在你的脑子里 一提到莲花就是蓝莲花。。。。 脑子锈逗，无知无畏吧。
  

2：技术复用就可以定性一样么 ？那请问APT1报告里面提到了 nc、pwddump等工具你咋不说APT1报告是恶意黑客工具通报呢？（哦忘问了，你知道啥是APT不，要不要给你科普一下
 
3：请问你google给的链接哪一个串是能对应上的？请吹牛乱喷之前先打打草稿再来？
  

4：感染量大就不是APT么？请先回去好好看看desert falcons、Carbanak_APT、Equation这些APT报告中给出的感染量，然后再说话。
  

 哎 不得不说现在年轻人的浮躁啊。。。。。 读懂人家360的报告再说吧 ..
亮了

观察员  (1级)  2015-06-08

@ 12345     不要太认真   太认真了你就输了              
亮

https://www.freebuf.com/articles/system/69356.html 8/13



2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台

观察员  (1级)  2015-06-08 9楼 回复

别解释，看你自己写的有多严谨。  
亮了 (

12345  2015-06-08 回

@ 观察员    我认为至少比360的严谨多了
亮了

观察员  (1级)  2015-06-08

@ 12345  你怒了吧   哈哈哈        
亮

cool_fire  2015-06-08 10楼 回复

错别字有点多[微笑]
亮了 (

https://www.freebuf.com/articles/system/69356.html 9/13



2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台

毒舌评论砖家  (1级)  2015-06-08 11楼 回复

另外关于64位强密匙绕过杀软，其实质就是OceanLotus Encryptor 在创建进程时候的用到的一个64bytes的随机数，并没有什么其他的作用。
  

上次喷我说“–help”后面的参数是接下来解密密钥的那两位“喷子兄弟”请问你们在哪里？我当时就是简单地看了一下，里面有一个PathFileExists判断参数是否是一个路径，如果是则会从
源中释放一个文件。但是这是不可能执行的。当时就有点武断的判断参数没用。

亮了 (

nick123  2015-06-08 回

@ 毒舌评论砖家    密钥是有用的， 释放temp文件的时候，先用随机产生的密钥加密固定文件偏移位置的0×10字节的 0×12345678，用相同的密钥去加密特定偏移的其他数据， 然后起
程temp文件，传刚才生成的64位密钥，通过–help后面的密钥去先解密刚才加密后的0×10字节的地方，如果用密钥解密出来的数据等于0×12345678，说明密钥是正确的，才会走释放
qq.exe 和bundle.rdb的流程。

亮了

522586971  2015-06-08

@ nick123
  

人家不就那个意思吗？

亮

晴天  2015-06-08

@ 522586971  我说的是 毒舌评论砖家 上一篇的报告。不是针对这个作者的。
亮

sdf  2015-06-08 回

@ 毒舌评论砖家    貌似是在说我,你上篇文章说不是APT,然后我告诉你,–ping是解密密钥,解密后会释放doc.我喷你是因为你连这么重要的地方都没细看就敢说不是APT,现在竟然还舔着
来提之前的事.拜托你再仔细看看解密后的一系列操作,再来判断是不是有特殊目的木马再来反喷好么
  

此外,本文中作者说qq国际版和yahoo不是政府通用IM,其实吧,我觉得,木马应该释放一个文件名叫’我是木马,来点我呀.exe’的文件到桌面上才能获得更高的成功率吧…..这明显是伪装成正
序,来迷惑管理人员的好么

亮了

123  2015-06-08

@ sdf  ”特殊目的“就是APT？
亮

观察员  (1级)  2015-06-08

@ 123  难道是你妈妈喊你回家吃饭呐？     
亮

sdf亲爱的  2015-06-08

@ sdf  他分析的无论多详细，只要出点错就会被你们狂喷。这次你找不到漏洞了就开始"此外,本文中作者说qq国际版和yahoo不是政府通用IM,其实吧,我觉得,木马应该释放一个文件名
是木马,来点我呀.exe’的文件到桌面上才能获得更高的成功率吧…..这明显是伪装成正常程序,来迷惑管理人员的好么".这篇文章已经够详细了，你还叫人家回去分析啥啊？你这就是选择
视。

亮

sdf  2015-06-08

@ sdf亲爱的  先说此文,技术分析上没有问题,而且我也没有喷作者的意思,最起码他有分析样本的细节,然后根据分析结果作出判断.但是FB最近这两次的文章都太侧重对单个样本的分析
没有看到攻击的发起来源与受害目标的统计信息,也没有对几年的样本活动与分布进行统计方面的分析,只凭单个样本的行为来意测本次是否为APT事件或者是针对XX部门的APT事件.这
片面.一个APT事件除了技术因素,非技术因素也是一个非常重要的手段,难道发给一个Gh0st远控,然后每天将目标机器上的红头文件拷贝下来就不算APT了么?所看到的数据量级不一样,
点也就不一样这很正常.但是没有看过就拿出来瞎说,就是另外一回事了.

亮

nick123  2015-06-08 回

@ 毒舌评论砖家    密钥是有用的， 释放temp文件的时候，先用随机产生的密钥加密固定文件偏移位置的0×10字节的 0×12345678，用相同的密钥去加密特定偏移的其他数据， 然后起
程temp文件，传刚才生成的64位密钥，通过–help后面的密钥去先解密刚才加密后的0×10字节的地方，如果用密钥解密出来的数据等于0×12345678，说明密钥是正确的，才会走释放
qq.exe 和bundle.rdb的流程。

亮了

观察员  (1级)  2015-06-08 回

@ 毒舌评论砖家    建议先把人家的报告看明白了再说吧   真丢人 还没搞明白咋回事就出来乱喷。。。。打脸了吧。哎。。多不好意思 啊。。。哎  。 哎。。
亮了

https://www.freebuf.com/articles/system/69356.html 10/13



2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台

360水军总指挥  2015-06-08 12楼 回复

红衣啊，上次我可以喷人家"目光有限，看不到线面和维度“，也可以喷人家”没分析明白",还可以喷人家“普通木马就不是APT了吗".可这次你让我怎么喷人家啊? 红衣，哎，别走啊。。。
上次的钱还没有结呢啊。。。。。。

亮了 (

晴天  2015-06-08 13楼 回复

密钥是有用的， 释放temp文件的时候，先用随机产生的密钥加密固定文件偏移位置的0×10字节的 0×12345678，用相同的密钥去加密特定偏移的其他数据， 然后起进程temp文件，传刚
才生成的64位密钥，通过–help后面的密钥去先解密刚才加密后的0×10字节的地方，如果用密钥解密出来的数据等于0×12345678，说明密钥是正确的，才会走释放qq.exe 和bundle.rdb
流程。

亮了 (

观察员  (1级)  2015-06-08 14楼 回复

密钥是有用的， 释放temp文件的时候，先用随机产生的密钥加密固定文件偏移位置的0×10字节的 0×12345678，用相同的密钥去加密特定偏移的其他数据， 然后起进程temp文件，传刚
才生成的64位密钥，通过–help后面的密钥去先解密刚才加密后的0×10字节的地方，如果用密钥解密出来的数据等于0×12345678，说明密钥是正确的，才会走释放qq.exe 和bundle.rdb
流程。

亮了 (

123  2015-06-08 回

@ 观察员    复制别人的东西要脸吗？
亮了

观察员  (1级)  2015-06-08

@ 123  乱说乱喷人要脸么
亮

观察员  (1级)  2015-06-08

@ 观察员    没看懂报告就否定质疑人家要脸么？
亮

观察员  (1级)  2015-06-08

@ 123  你妈妈都喊你回家吃饭  还在这瞎逼逼要脸么？
亮

522586971  2015-06-08

@ 观察员 
  

报告不需要看懂，只需要知道狗嘴里吐不出象牙，360公关嘴里没几句实话就够了
亮

观察员  (1级)  2015-06-08

@ 522586971  看不懂你在这逼逼啥     别出来丢人了吧
亮

观察员  (1级)  2015-06-08

@ 522586971   你那狗嘴里能吐出象牙   那吐一个给大爷看看        
亮

观察员  (1级)  2015-06-08 15楼 回复

@ 123    密钥是有用的， 释放temp文件的时候，先用随机产生的密钥加密固定文件偏移位置的0×10字节的 0×12345678，用相同的密钥去加密特定偏移的其他数据， 然后起进程temp文
件，传刚才生成的64位密钥，通过–help后面的密钥去先解密刚才加密后的0×10字节的地方，如果用密钥解密出来的数据等于0×12345678，说明密钥是正确的，才会走释放qq.exe 和
bundle.rdb的流程。

俺说的对不？     难道你又要质疑？
亮了 (

钊文天下  2015-10-21 16楼 回复

据说360天眼的报告有300页 被删除了90%，就剩十几页。
亮了 (

选择文件 未选择任何文件

https://www.freebuf.com/articles/system/69356.html 11/13



2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台

必须 您当前尚未登录。登陆？注册
昵称

请输入昵称

必须（保密）
邮箱

请输入邮箱地址

表情 插图

提交评论(Ctrl+Enter) 取消 有人回复时邮件通知我

比尔.盖茨
iplaynice

5 85
文章数 评论数

最近文章

独家首发 | CVE-2017-11816 GDI信息泄露漏洞分析

2017.10.13

基于unicorn-engine的虚拟机的实现(WxSpectre)

2017.06.15

原创工具：Pinda套件---恶意样本分析利器

2016.11.25

浏览更多

相关阅读

现代版荆轲刺秦王：Struts2 REST插…

深入剖析某国外组织针对中国境内企…

技术讨论 | 利用XXE漏洞获取NetNTL…

如何巧妙的从ntds.dit中提取Hash和域…

沙虫（CVE-2014-4114）相关威胁综…

特别推荐

https://www.freebuf.com/articles/system/69356.html 12/13



2018/12/14 技术剖析：海莲花OceanLotus Encryptor样本分析 - FreeBuf互联网安全新媒体平台

活动预告

11月 10月 10月

FreeBuf精品公开课·双11学习狂欢 【16课时-连载中】挖掘CVE不是 【首节课仅需1元】挖掘CVE不是梦
节 | 给努力的你打打气 梦（系列课程2）

已结束 已结束 已结束

9月

【已结束】自炼神兵之自动化批量
刷SRC

已结束

Copyright © 2018 WWW.FREEBUF.COM All Rights Reserved 沪ICP备13033796号

https://www.freebuf.com/articles/system/69356.html 13/13