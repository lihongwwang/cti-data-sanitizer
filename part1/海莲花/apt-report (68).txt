2019/7/3 セキュリティ研究センターブログ: OceanLotusが使う検出回避テクニック

セキュリティ研究センターブログ

2019年4⽉16⽇(⽕)

OceanLotusが使う検出回避テクニック

検体解析やインシデント対応の中で、あるテクニックがオペレーションの多くの場⾯で使われているのを観測する事があります。

最近の標的型攻撃では、APT10ANEL[1]やBlackTechTSCOOKIE[2]などエンコード・暗号化されたコードを実⾏時にデコード・復号し、メモリ上でPE形式
のコードを実⾏するタイプ(ここでは、ローダーと呼称します)が多く観測されています。

攻撃者グループが使うエンコード・暗号⽅式も違いがあり、上述のバックドア型のマルウェアだけでなくMimikatzのようなツールも検出を回避するのにローダ
ーが使われる事があります。

今回は、弊社で観測したOceanLotus/APT32の検出回避テクニックについて解説します。

 OceanLotus/APT32は、ベトナムに拠点を置くと⾒られるグループで東南アジア圏で活発な活動が観測されています。FireEye社は、彼らの観測から⾃動⾞関
連企業が標的とされているという⾒解を発表しています[3]。弊社でも国内関連企業の海外拠点への攻撃を観測しており、その可能性は⾼いと考えています。

OceanLotusの検出回避テクニック

検出を回避するために2つのテクニックを活⽤したローダーを使っています。

DLLSide-Loading

このテクニックは、正規のEXEファイルとそのEXEファイルがロードするDLLファイルを改ざんしたものを使いアンチウイルス製品やホワイトリスト対策を回
避する事を⽬的としています。

Base64エンコード

改ざんしたDLLファイルには、Base64エンコードされたコードが埋め込まれており実⾏時にデコードし、デコードしたコードを実⾏します。（図１）

最終的にはメモリ上にPE形式のコードが展開・実⾏されます。（図２）

図1.DLLファイルに埋め込まれているBase64コード

図2.検知回避テクニックの概要図

メモリ上に展開されるPE形式のコード

代表的なものはESET社が分析しているバックドア[4]がありますが、他にもダウンローダーや侵⼊後に使われると思われるツールの実⾏にも、この検出回避テ
クニックが使われています。



1)ダウンローダー

SHA256:358df9aba78cf53e38c2a03c213c31ba8735e3936f9ac2c4a05cfb92ec1b2396
FileType:Win32DLL

blog.macnica.net/blog/2019/04/oceanlotus-218a.html 1/3



2019/7/3 セキュリティ研究センターブログ: OceanLotusが使う検出回避テクニック
TimeStamp:2018-09-2404:47:10
LinkerVersion:14.0

この検体は、PaloAlto社が”KerrDown”と呼称しており[5]、最終的にはメモリ上にPE形式のコードが展開されます。内部に埋め込まれている通信先をパラメー
タとして受け取り、通信先からダウンロードしたコードをメモリ上で実⾏します。（図３）

図3.PE形式のコードへ渡されるパラメーター

弊社では、この検体がダウンロードするpngファイルの分析ができていないのですが、公開情報[6]では、類似のURLからファイルがダウンロードされた後に
CobaltStrikeBeaconが実⾏されるという情報が共有されています。

2)Windowsユーザ追加ツール
SHA256:53efaac9244c24fab58216a907783748d48cb32dbdc2f1f6fb672bd49f12be4c
FileType:Win32DLL
TimeStamp:2018-11-2205:21:25
LinkerVersion:14.0

この検体は実⾏されると、内部に埋め込まれているchromeインストーラーを起動する事からchromeインストーラーに偽装されて使われるものではないかと推
測しています。
最終的には、検体に埋め込まれているユーザ名とパスワードが、メモリ上に展開されるPE形式のコードに渡されて、そのユーザとパスワードが実⾏端末上に追
加されます。（図４）
この事から侵⼊後に内部活動をしやすくするために、複数の端末で実⾏させて共通のユーザとパスワードを登録するのに使われるものではないかと考えていま
す。

図4.PE形式のコードへ渡されるパラメーター

登録するユーザー情報
user:SUPPORT_388945a1
password:@Abc123456

3)スニファー
SHA256:7fd526e1a190c10c060bac21de17d2c90eb2985633c9ab74020a2b78acd8a4c8
FileType:Win32DLL
TimeStamp:2018-08-0802:52:52
LinkerVersion:14.0

この検体は実⾏されると、メモリ上にPE形式のコードを展開し、展開されたコードは、感染端末ネットワーク内の通信を傍受します。
パラメータとして、内部に埋め込まれている設定ファイルのパスが渡されて、そのファイルを読み込みに⾏きます。（図５）コード解析の結果から設定ファイル
はBase64でエンコードされているものである事が分かりました。

図5.PE形式のコードへ渡されるパラメーター

通信をモニターする為に、winpcapのDLLファイルから動的にAPIをロードします。（図６）

図6.winpcapが提供するAPIをロードする処理

WindowsFirewallのルールに当該検体の通信を許可する設定を追加し(図7)、内部処理⽤に65000/TCPのポートで接続待ち受けを⾏います。

blog.macnica.net/blog/2019/04/oceanlotus-218a.html 2/3



2019/7/3 セキュリティ研究センターブログ: OceanLotusが使う検出回避テクニック

図7.FWに追加されたルール

後述する設定ファイルに記載されたMACアドレスを使いARPスプーフィングを⾏いゲートウェイ向けの通信を傍受できるようにします。

図8.ARPスプーフィングのパケット

実際の設定ファイルが⼊⼿できておらずコード解析からの推測になりますが、設定ファイルは下図のような内容でないかと思われます。（図9）

図9.推測される設定ファイル内容(//は、コメントとして追記)

動作する為に必要な設定ファイルには内部ネットワークの情報を記載する必要がある事から、この検体も侵⼊後の内部活動で使われるツールと考えています。

今回取り上げた検体がメモリ上に展開するPE形式のコードに渡すパラメーターの第⼀引数には、いずれも下記パスが使われており、これらの検体が同⼀端末で
作られた可能性も考えられます。

C:\Users\Administrator\Desktop\api\temp\royal\<EXEファイル名>

OceanLotusだけではなく、BlackTechはRC4暗号化したファイルを好んで使う等、攻撃者グループが、あるテクニックをオペレーションの⼀連の中の複数の
場⾯で使うケースがあります。ある端末で発⾒されたテクニックは、他端末の感染有無の確認項⽬として使うなどインシデント対応で活⽤する事ができると考え
ています。

インディケーター情報

358df9aba78cf53e38c2a03c213c31ba8735e3936f9ac2c4a05cfb92ec1b2396
53efaac9244c24fab58216a907783748d48cb32dbdc2f1f6fb672bd49f12be4c
7fd526e1a190c10c060bac21de17d2c90eb2985633c9ab74020a2b78acd8a4c8

65000/tcp(スニファーがオープンするポート)

C:\ProgramData\setting.cfg(スニファーが読み込む設定ファイル)

https://outlook.updateoffices[.]net/vean32.png

Reference
[1]https://jsac.jpcert.or.jp/archive/2019/pdf/JSAC2019_6_tamada_jp.pdf
[2]https://blogs.jpcert.or.jp/ja/2018/03/tscookie.html
[3]https://www.bloomberg.com/news/articles/2019-03-20/vietnam-tied-hackers-target-auto-industry-firms-fireeye-says
[4]https://www.welivesecurity.com/wp-content/uploads/2018/03/ESET_OceanLotus.pdf
[5]https://www.paloaltonetworks.jp/company/in-the-news/2019/tracking-oceanlotus-new-downloader-kerrdown
[6]https://twitter.com/blackorbird/status/1086186184768815104

投稿者TAKEUCHI⽇時2019年4⽉16⽇(⽕)14:28APT,インテリジェンス,マルウェア,標的型攻撃|個別ページ
赞 18

| Tweet | 2 |

blog.macnica.net/blog/2019/04/oceanlotus-218a.html 3/3