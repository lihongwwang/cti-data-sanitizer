Operation（Thủy Tinh）OceanStorm：隐匿在深海巨渊下的邪恶莲花

概述
海莲花（OceanLotus）是一个据称东南亚背景的 APT 组织。该组织最早于 2015 年 5 月被天眼实验室所揭露并命名，其攻击活动最早可追溯到 2012 年 4 月，攻击目标包括人权代表、异见人士、媒体、银行、海事机构、海域建设部门、科研院所和航运企业，后扩展到几乎所有重要的组织机构，受害区域涉及东亚、东南亚、欧洲等地区，持续活跃至今。
本文内容是对海莲花组织在过去一段时间内攻击手法做一个粗略的回顾，不讨论受害单位，报告中涉及的恶意域名和跳板均已无法访问，
从 2020 年中开始海莲花组织逐渐放弃了基于鱼叉邮件的投递方式，开始通过渗透的手段对高价值目标进行攻击活动，经过长时间的跟踪挖掘，发现该组织在入侵和横向移动过程中具备使用 0day/Nday 漏洞的能力。

横向移动
相对于海莲花组织相对单一的白利用组件，横向移动过程中使用的脚本可谓种类繁多，本报告仅列出该组织使用频率最高的几个脚本。

爆破脚本
海莲花早期在内网中使用的爆破脚本如下
功能较为简单，仅针对 445 端口下的 administrator 账户进行爆破
经过数次版本迭代后，增加了对 MSSQL、FTP、HTTP 的爆破
增加了对常见端口的扫描

NbtScan 脚本
海莲花在横向移动过程中会使用 nbtscan 对内网进行扫描，利用 PS 脚本将编码后的 Nbtscan 注入到 Notepad.exe 中。
使用的 Nbtscan 1.0.35 版本。

Getinfo 脚本
该 PS 脚本在执行过程中会收集操作系统相关信息、域控信息、ssh 状态、RDP状态、反病毒产品、所有用户名、安装的程序列表、ipconfig、正在运行的服务、网络连接状态、进程列表、磁盘信息、Administrator 用户下的目录树、C 盘根目录树。
最后将上述信息整理成 html 落在文件系统上，之后会被攻击者加密打包上传到图床网站。

管道注入脚本
在执行过程中从管道中读取 Payload，对其进行解密
之后会随机启动如下进程中一个，并将 Shellcode 注入该进程中。
进程名
makecab.exe
systray.exe
w32tm.exe
bootcfg.exe
diskperf.exe
esentutl.exe
typeperf.exe
注入代码如下：

Empire 脚本
海莲花使用 Empire 框架控制内网主机，搜索目标。最终会在指定目标上释放白利用组件，最终执行 cobaltstrike 远控。

0day/Nday
海莲花组织是为数不多的能够结合特定环境定制化开发挖掘0day/Nday漏洞的APT 团伙，手段较为高超，能够发起中等规模的供应链打击。

样本分析
白利用组件
海莲花组织使用的恶意 dll 经过数代版本的迭代，其功能一直保持不变，都是用来解密 shellcode，但是解密方式有所不同，大体可以分为如下几类：
读资源节解密 shellcode：
读自身解密 shellcode
从 data 节读取 shellcode
Shellcode 在执行过程中一般都会先进行循环解密，
会解密出后续代码
基于 Shellcode 执行结果，大体上可以分为机器名加密组件和非机器名加密组件，区别在于机器名加密组件在执行过程中会读取本机机器名通过机器名对后续Payload 进行 AES 解密。如果机器名错误则无法解密出后续的 cobaltstrike。如果基于 shellcode 的行为进行分类，则可以分为如下几类：
常规类，执行过程中解密 cobaltstrike 并执行，较为常见不做介绍。
Dropper 类，执行过程中会将白利用组件释放到%temp%目录下，并创建计划任务。
读文件类，在执行过程中读取特定目录下的文件，第二阶段 shellcode 后续对文件内容进行解密。
注入/服务类，在执行过程中启动一个挂起的进程或者创建一个服务，用于执行第二阶段 shellcode。
最终执行的远控，从家族上来分大体分为两类，一类是 cobaltstrike，另一个是Remy Rat，该家族样本使用频率较低，代码如下：
从功能上来分有如下几类：
直连 C2 类，这种较为常见不做过多赘述。
管道类，创建管道，等待连接。
端口监听类，等待内网其他受控主机连接指定端口。

挖矿
挖矿组件如下：
被入侵的电脑被创建一个服务，指向 SCCreateProcess.exe，服务名为SCCREATEPROCESS:
而 SCCreateProcess.exe 被执行起来后，会获取到该 exe 的文件名，然后附件.bat后缀后执行起来：
而 SCCreateProcess.exe.bat 文件被执行起来后，会执行起来同目录下的ControlPanel.exe.bat 文件：
而 ControlPanel.exe.bat 文件会通过名字为 vmware-authd.exe 的挖矿程序，传递矿池和钱包地址进行挖矿操作。

总结
目前，基于奇安信威胁情报中心的威胁情报数据的全线产品，包括奇安信威胁情报平台（TIP）、天擎、天眼高级威胁检测系统、奇安信 NGSOC、奇安信态势感知等，都已经支持对此类攻击的精确检测。