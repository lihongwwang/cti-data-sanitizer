海莲花（APT32）组织 wwlib-side-loading攻击链分析

前⾔
⾃2015年⾸度披露以来，被报道的海莲花组织攻击链已经达到⼗余种，并伴有显著的时间活跃性特征。2018年以后，海莲花组织开始使⽤⼀种新的攻击⼿法，并且在之后的时间⾥持续增加攻击诱饵的投放数量，同时不断改进攻击链条的细节。统计发现，这条我们称之为wwlib side-loading的攻击链⾄今已发展出多个版本，可以作为海莲花组织近年主要攻击链来看待。

攻击链概述
wwlib side-loading攻击链是上半年乃⾄2018年以来海莲花组织最主要的攻击⽅式，具有稳定、抗检测等特点。同时，该攻击链的组件在攻防对抗中演化出了多个变种，使得其恶意⾏为越来越难以被捕获。
该攻击流程的主要⾏为及其在攻击链中的组成如下：
此攻击链中，海莲花组织在触发⼯具和安装⽊⻢部分的⾏为⽐较有代表性，并且随时间发展出多个变化的⽀链，使得攻击链更为复杂和健壮。

攻击链流程分析
下⾯将以⼀个典型的攻击样本展示此攻击链的执⾏流程。

侦察⽬标阶段
海莲花组织会分析⽬标所在群体和社会类型，编写对应的诱饵⽂档。根据攻击样本的诱饵⽂档推断，海莲花组织跟踪并收集了越南多个商业组织或⾮盈利组织的信息，使⽤有⾼度欺骗性的⽂字或⽂档作为诱饵进⾏攻击，其攻击⽬标则推断为与被收集情报组织相关的⼯作⼈员及其设备。

制作⼯具阶段
该阶段，海莲花⼀般会准备两个⽂件作为武器包：
⽂件名 属性和功能
xxxx.exe Microsoft office word程序可执⾏⽂件，⽤于免杀和绕过UAC
wwlib.dll 恶意程序主体，被word程序加载并调⽤恶意函数，执⾏攻击
系统中显示为：
可以看到wwlib.dll为隐藏⽂件，可执⾏⽂件有word图标，这在默认⽂件夹选项的系统中⽐较有欺骗性：
该武器包诱饵⽂件如下图：
⽂档由图⽚和⽂本组成，但内容皆为乱码。
该诱饵⽂档名称为“Noi dung chi tiet thu moi tham du hoi nghi va thong tin lich trinh dien ra hoi nghi tai Singapore”，⼤意为“使⽤这些信息可以获得新加坡最受关注的活动和信息”。

投递⼯具阶段
该攻击链中，海莲花组织使⽤⻥叉攻击的⽅式进⾏⽂件的投放，邮件中附件为rar压缩包形式，⽂件名为“Thu moi tham du 2019.rar”。⼤意为“邀请函2019”。

触发⼯具阶段
当⽤户下载解压并双击执⾏word可执⾏⽂件时，恶意wwlib.dll运⾏库被⾃动加载执⾏。
该阶段为此攻击链的分化阶段，海莲花组织在不同时期构造了不同的wwlib.dll程序，其触发⽅式不尽相同，可以作为变种来看待。
该程序使⽤的wwlib⽂件为本攻击链在2019年度的主要变种之⼀。该程序的主要恶意代码堆放在DllMain⼊⼝处，其主要功能hook LdrLoadDll函数，使得此函数运⾏⾄返回之前加载指定恶意shellcode并运⾏。
程序hook系统函数LdrLoadDll，将注⼊函数写⼊LodrLoadDll返回位置，这样系统加载库⽂件后即会进⼊指定位置的InjectPayload函数。此处的hook代码⽐较规范：
InjectPayLoad函数中，程序⾸先修复了hook点，⽽后解密代码段中的shellcode，在内存中加载并执⾏：
此shellcode分为多个层次，各层分别负责备运⾏环境、解密最终payload、下载远控⼯具等功能，各层shellcode间使⽤线程调⽤：
其最终下载链接为https://api.ciscofreak.com/Kgx2：

安装⽊⻢阶段
该Shellcode下载到的Kgx2为另外⼀段shellcode，其功能为解密⼀个pe⽂件并反射加载。解密出的pe⽂件为Cobalt Strike Beacon受控端程序。
Shellcode Kgx2解密pe⽂件：
解密出的Cobalt Strike Beacon：

建⽴连接阶段
该beacon受控端会与主控端api.ciscofreak.com建⽴连接，使⽤tls和443端⼝进⾏通信：

执⾏攻击阶段
该beacon⽊⻢接收控制端指令并展开攻击，具有以下功能：
1. 远程线程注⼊，可指定⽬标进程名称或pid；
2. Spawn，将beacon shell 派⽣⾄新的程序；
3. 命名管道，连接、关闭指定命名管道，使⽤命名管道通信；
4. ⽂件操作，上传与下载⽂件，修改⽂件时间；
5. ⽂件系统操作，切换⽬录、创建删除⽂件夹、写⼊环境变量等；
6. 命令⾏执⾏，直接执⾏指定的cmd命令；
7. ⽹络监听，包括创建服务端并监听指定端⼝、本地⽹络通信转发等；
8. 获取信息，查看所有进程信息，查看指定⽬录下⽂件信息；
9. 创建服务，将指定程序以服务⽅式运⾏；
10. 权限操作，包括检查权限，提升权限；
11. Shellcode执⾏，使⽤powershell通过指定端⼝下载并运⾏；
12. 域内渗透，使⽤kerberos票据。

攻击链分⽀跟踪
作为最暴⼒直接的攻击链，海莲花对wwlib side-loading攻击⼗分依赖，攻击次数较多。该攻击链载荷最早被观测到是在2018年之前，此时期使⽤的载荷相对单⼀。进⼊2019年后，该攻击链载荷的数量与变种种类皆⼤幅增加。
我们对已发现的海莲花wwlib恶意程序进⾏了统计，结果如图：
由统计图可以看出，该攻击链在最近两年⼀直维持着⼀定的活跃度，⽽攻击链在不同时期的主要攻击载荷也不尽相同，呈现出了迭代的趋势。

攻击链变种情况
海莲花wwlib side-loading攻击链变种主要体现在投递和触发阶段，具体表现为使⽤不同的诱饵⽂档和⼀阶段恶意载荷，可以按时期分为三个⼤类：
第⼀类：2018年⾄2019年第⼀季度；
第⼆类：2019年上半年；
第三类：2019年第⼆季度。
对三类样本进⾏分析发现，随着时间的推移，wwlib side-loading变种载荷的代码复杂度逐渐上升，陆续增加了花指令、常量隐藏、rc4加密、⽩利⽤嵌套等对抗功能，增⼤了对其进⾏检测的难度。

总结
作为最暴⼒直接的攻击⽅式，wwlib side-loading是海莲花⼗分依赖的⼀条攻击链。该攻击链载荷最早被观测到是在2018年之前，此时期使⽤的载荷相对单⼀。进⼊2019年后，海莲花组织对该攻击链的流程和载荷进⾏了多次改进升级，并将其作为主要攻击⽅式来使⽤，攻击⾯涵盖中国、越南等国家。由于该攻击链具有⼀定的免杀和反检测能⼒，需要相关企业或组织的⼯作⼈员在保障安全检测设备正常运⾏的同时，进⼀步提升对未知邮件附件的敏感度，将海莲花组织的攻击拦截在⼊侵阶段之前。