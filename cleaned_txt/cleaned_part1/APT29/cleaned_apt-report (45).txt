OPERATION GHOST
The Dukes aren’t back — they never left

1. EXECUTIVE SUMMARY
It is exceptionally rare for a well-documented threat actor, previously implicated in very high-profile attacks, to stay completely under the radar for several years. Yet, in the last three years that is what APT group the Dukes (aka APT29 and Cozy Bear) has done. Despite being well known as one of the groups to hack the Democratic National Committee in the run-up to the 2016 US election, the Dukes has received little subsequent attention. The last documented campaign attributed to them is a phishing campaign against the Norwegian government that dates back to January 2017.

In this white paper, we describe how we uncovered that the Dukes had been running successful espionage campaigns while avoiding public scrutiny, thanks to stealthy communication techniques and retooling. We call these newly uncovered Dukes campaigns, collectively, Operation Ghost, and describe how the group has been busy compromising government targets, including three European Ministries of Foreign Affairs and the Washington DC embassy of a European Union country, all without drawing attention to their activities.

Key points in this white paper:
The Dukes never stopped their espionage activities.
• Operation Ghost likely started in 2013.
• The last known activity linked to Operation Ghost occurred in June 2019.
• ESET researchers identified at least three victims: all European Ministries of Foreign Affairs including the Washington DC embassy of a European Union country.
• The Dukes have used four new malware families in this campaign: PolyglotDuke, RegDuke, FatDuke and LiteDuke.
• Operation Ghost uses a previously documented Dukes backdoor: MiniDuke.
• The Dukes have leveraged online services such as Twitter, Imgur and Reddit to act as primary Command and Control (C&C) channels for their first-stage malware.
• The Dukes have used very stealthy techniques such as steganography to hide communications between compromised machines and their C&C servers.

2. BACKGROUND
The Dukes, also known as APT29 and Cozy Bear, is an infamous cyberespionage group active since at least 2008. In particular, it is known for being one of the adversaries to have breached the Democratic National Committee during the 2016 US presidential election. It was even featured in a joint report issued by the FBI and the Department of Homeland Security (DHS), as part of malicious cyber-activities the report dubbed Grizzly Steppe. That report was published in 2017 and describes malicious activities that occurred around the presidential election of 2016.

This section is a summary of the group’s previously documented activities to refresh the reader’s memory, since the last related publication dates from almost three years ago. Our most recent discoveries are detailed in the subsequent sections of this white paper.

2.1 Timeline
Even though the group’s activities are believed to have started in 2008, the first public report was released in 2013 with the analysis of MiniDuke by Kaspersky. Over the next two years, multiple reports dissected the Dukes’ arsenal, including a comprehensive summary by F-Secure of the group’s activities from 2008 to 2015.

One of the most recent attacks that we can link to the Dukes is the January 2017 phishing attempt against the Ministry of Foreign Affairs, the Labour Party and the Armed Forces of Norway. Since then, most security experts have believed the Dukes went dark or completely changed their arsenal to pursue their mission.

In November 2018, a strange phishing campaign hit dozens of different organizations in the United States, including government agencies, and think tanks. The attack leveraged a malicious Windows shortcut (a .lnk file) that bore similarities to a malicious shortcut used by the Dukes in 2016. However, that earlier sample was available in a public malware repository for many years, allowing another actor to easily conduct a false-flag operation. In addition, there is no evidence that any custom malware used only by the Dukes was employed during this attack. From FireEye’s detailed analysis of the attack, it was not possible to make a high-confidence attribution to this threat actor.

2.2 Targets
Over the years, it has been possible to draw the big picture of the Dukes main targets. The group is primarily interested in spying on governments either in the West or in former USSR countries. Besides governments, the group has also targeted various organizations linked to NATO, think tanks, and political parties.

This targeting suggests a clear interest in collecting information allowing a better understanding of future international political decisions, which would seem of most interest to a government. Unlike other groups such as GreyEnergy and TeleBots, it is important to note that we have never seen the Dukes engaged in cybersabotage operations.

Surprisingly though, the group also has conducted spying operations outside its main focus. In 2013, Kaspersky researchers found evidence that part of the Dukes toolset had been used against drug dealers in Russia. This may suggest that this toolset is not only used for collecting foreign intelligence but also for conducting LE investigations of criminal activities.

2.3 Tools and tactics
The Dukes group is known to be a major player in the espionage scene. It is associated with a large toolset with more than ten different malware families written in C/C++, PowerShell, .NET and Python. It has also adopted living-off-the-land tactics, misusing standard IT tools such as PsExec and Windows Management Instrumentation (WMI).

As mentioned before, we invite our readers to read the F-Secure summary for an analysis of the earlier malware platforms used by this threat actor.

Delivery
The group’s main initial tactic to breach a network is to send spearphishing emails that contain a link or an attachment. In order to increase the attackers’ chances, it is designed to be a subject of particular interest of the recipient. This is different from mass-spreading malicious email campaigns where the same email is sent to hundreds or thousands of people by crimeware actors.

When targets click on these malicious links or attachments, a .zip archive that contains a malicious, macro-enabled Word document and a decoy will be downloaded. If victims then open the malicious document and enable the macro, it will then install the PowerDuke backdoor. In other cases, malicious Windows shortcuts (.lnk files) have been used instead of Word documents with malicious macros.

However, this is not the only method used by the Dukes to gain initial access. In 2014, the Dukes started using two mass-spreading methods to deliver the OnionDuke implant:
• Trojanized pirated applications downloaded via BitTorrent
• A malicious TOR exit node to trojanize downloaded applications on the fly

OnionDuke has some capabilities outside the standard espionage features, such as a Denial of Service (DoS) module, but we have not observed them used in the wild.

Finally, the Dukes are also known for using multiple implants to compromise a target. It is very common to see an implant delivering another one to regain control of a system.

Command and Control (C&C)
The Dukes have employed several interesting tactics to hide the communications between the implants and their C&C servers, including the use of social media platforms and steganography.

MiniDuke and HammerDuke leveraged Twitter to host their C&C URLs. In addition, they use a Domain Generation Algorithm (DGA) to generate new Twitter handles. Each time the malware generates a new handle, it fetches the Twitter page corresponding to that handle and searches the page for a specific pattern, which is the encrypted C&C URL.

In CloudDuke, the operators leveraged cloud storage services such as OneDrive as their C&C channels. They were not the first group to use this technique, but it is generally effective for the attackers as it is harder for defenders to spot hostile connections to legitimate cloud storage services than to other “suspicious” or low-reputation URLs.

Moreover, the Dukes like to use steganography to hide data, such as additional payloads, in pictures. It allows them to blend into typical network traffic by transferring valid images while its true purpose is to allow the backdoor to communicate with the C&C server. This technique has been described in Volexity’s PowerDuke blogpost.

3. OPERATION GHOST
After 2017, it was not clear how the Dukes evolved. Did they totally stop their activities? Did they fully re-write their tools and change their tradecraft?

We spent months apparently chasing a ghost then, a few months ago, we were able to attribute several distinct intrusions to the Dukes. During the analysis of those intrusions, we uncovered several new malware families: PolyglotDuke, RegDuke and FatDuke. We call the Dukes’ campaigns using these newly discovered tools Operation Ghost.

3.1 Targets and timeline
We believe Operation Ghost started in 2013 and was still ongoing as of this writing. Our research shows that the Ministry of Foreign Affairs in at least three different countries in Europe are affected by this campaign. We also have discovered an infiltration by the Dukes at the Washington, DC embassy of a European Union country.

This targeting is not surprising, and it shows that the Dukes are still active in high-profile organizations. We also believe that more organizations around the world might be affected but due to the use of unique C&C infrastructure for each victim, we were not able to identify other targets.

One of the first traces of this campaign is to be found on Reddit in July 2014. A message posted by one of the Dukes’ operators. The strange string using an unusual charset is the encoded URL of a C&C server and is used by PolyglotDuke as described in section 4.2.

3.2 Attribution to the Dukes
It is important to note that when we describe so-called “APT groups”, we’re making connections based on technical indicators such as code similarities, shared C&C infrastructure, malware execution chains, and so on. We’re typically not directly involved in the investigations and identification of the individuals writing the malware and/or deploying it, and the interpersonal relationships between them. Furthermore, the term “APT group” is very loosely defined, and often used merely to cluster the abovementioned malware indicators. This is also one of the reasons why we refrain from speculation with regard to attributing attacks to nation states and such.

On one hand, we noticed numerous similarities in the tactics of this campaign in comparison to previously documented ones:
• Use of Twitter (and other social websites such as Reddit) to host C&C URLs.
• Use of steganography in pictures to hide payloads or C&C communications.
• Use of Windows Management Instrumentation (WMI) for persistence.

We also noticed important similarities in the targeting:
• All the known targets are Ministries of Foreign Affairs.
• Two of the three known targeted organizations were previously compromised by other Dukes malware such as CozyDuke, OnionDuke or MiniDuke.
• On some machines compromised with PolyglotDuke and MiniDuke, we noticed that CozyDuke was installed only a few months before.

However, an attribution based only on the presence of known Dukes tools on the same machines should be taken with a grain of salt. We also found two other APT threat actors – Turla and Sednit – on some of the same computers.

On the other hand, we were able to find strong code similarities between already documented samples and samples from Operation Ghost. We cannot discount the possibility of a false flag operation; however, this campaign started while only a small portion of the Dukes’ arsenal was known. In 2013, at the first known compilation date of PolyglotDuke, only MiniDuke had been documented and threat analysts were not yet aware of the importance of this threat actor. Thus, we believe Operation Ghost was run simultaneously with the other campaigns and has flown under the radar until now.

PolyglotDuke (SHA-1: D09C4E7B641F8CB7CC86190FD9A778C6955FEA28), documented in detail in section 4.2 uses a custom encryption algorithm to decrypt the strings used by the malware. We found functionally equivalent code in an OnionDuke sample (SHA-1: A75995F94854DEA8799650A2F4A97980B71199D2) that was documented by F-Secure in 2014. It is interesting to note that the value used to seed the srand function is the compilation timestamp of the executable. For instance, 0x5289f207 corresponds to Mon 18 Nov 2013 10:55:03 UTC.

Similarly, the recent samples of the MiniDuke backdoor bear similarities with samples documented more than five years ago.

Given the numerous similarities between other known Dukes campaigns and Operation Ghost, especially the strong code similarities, and the overlap in time with previous campaigns, we assess with high confidence that this operation is run by the Dukes.

3.3 Tactics and tools
In Operation Ghost, the Dukes have used a limited number of tools, but they have relied on numerous interesting tactics to avoid detection.

First, they are very persistent. They steal credentials and use them systematically to move laterally on the network. We have seen them using administrative credentials to compromise or re-compromise machines on the same local network. Thus, when responding to a Dukes compromise, it is important to make sure to remove every implant in a short period of time. Otherwise, the attackers will use any remaining implant to compromise the cleaned systems again.

Second, they have a sophisticated malware platform divided in four stages:
• PolyglotDuke, which uses Twitter or other websites such as Reddit and Imgur to get its C&C URL. It also relies on steganography in pictures for its C&C communication.
• RegDuke, a recovery first stage, which uses Dropbox as its C&C server. The main payload is encrypted on disk and the encryption key is stored in the Windows registry. It also relies on steganography as above.
• MiniDuke backdoor, the second stage. This simple backdoor is written in assembly. It is very similar to older MiniDuke backdoors.
• FatDuke, the third stage. This sophisticated backdoor implements a lot of functionalities and has a very flexible configuration. Its code is also well obfuscated using many opaque predicates. They re-compile it and modify the obfuscation frequently to bypass security product detections.

During our investigation, we also found a previously unknown (and apparently now retired) third-stage backdoor, LiteDuke, that was used back in 2015. For the sake of historical completeness, it is analyzed in section 4.6.

Third, we also noticed that the operators avoid using the same C&C network infrastructure between different victim organizations. This kind of compartmentalization is generally only seen by the most meticulous attackers. It prevents the entire operation from being burned when a single victim discovers the infection and shares the related network IoCs with the security community.

3.4 Operational times
When it comes to cyberespionage, it is not uncommon for the malware developers and operators to follow the standard working hours of the country where they are located. For instance, we previously showed that Sednit operators were generally working from 9 AM to 5PM in the UTC+3 time zone. Previously, FireEye researchers noticed that the Dukes were also mainly operating in the UTC+3 time zone.

For Operation Ghost, we compiled three different types of timestamp in order to have an idea of their operational times:
• The time at which they uploaded C&C pictures to the Dropbox account used by RegDuke
• The time at which they posted encoded C&C URLs on the social media accounts used by PolyglotDuke
• The compilation timestamps of dozens of samples. We believe they were not tampered with, as they are consistent with what we see in ESET telemetry data.

It should be noted that some of these timestamps may have been generated by an automated command system or an automated build system.

The distribution aligns well with working hours in a UTC+2 or UTC+3 time zone, with occasional work during the night. This might be explained by a need to work at the same time as some of their victims.

4. TECHNICAL ANALYSIS
In this part, we present the technical analyses of the different malware stages used in Operation Ghost.

4.1 Compromise vector
Despite having analyzed the Dukes activities in several different organizations, we were not able to find the initial compromise vector. The group is known for sending well-crafted malicious emails, but we did not find any such samples.

It should also be noted that two of the three targeted organizations we identified had previously been compromised by the Dukes, mainly in 2015. As such, it is highly possible that the attackers kept control over the compromised networks during this whole period. We observed them pivoting in an already-compromised network using lateral movement tools like PsExec and stolen administrative credentials. As such, from only a few compromised machines, they are able to expand their operations.

4.2 PolyglotDuke: the first stage
PolyglotDuke is a downloader that is used to download and drop the MiniDuke backdoor. As mentioned in section 3.2, this downloader shares several similarities with other samples from previous Dukes campaigns such as the use of Twitter to retrieve and decode its C&C server address, as well as a custom string encryption implementation. Both 32- and 64-bit versions of PolyglotDuke were observed and have similar behavior. We dubbed this downloader PolyglotDuke in reference to its use of charsets from different languages to encode the C&C addresses.

Dropper
PolyglotDuke’s dropper embeds an encrypted PolyglotDuke within a resource type named GIF with the ID 129. The resource is encrypted with the following algorithm, using the string GIF89 from the resource (which is the 5 first magic bytes of the start of the GIF header) as the key:
clearText[i] = (i / 5) ^ cypherText[i] ^ aGif89[i % 5]
After decryption, the DLL is written to the current working directory and executed using rundll32.exe.

The custom string encryption algorithm used by the PolyglotDuke dropper is identical to the one used by PolyglotDuke, as well as other samples from previous Dukes campaigns. As mentioned in section 3.2, it’s worth noting that this dropper shares a great deal of functionality with OnionDuke, such as the use of a GIF resource, the use of the same algorithm with the string GIF89 as key to decrypt the resource, and the use of the same custom encryption algorithm to encrypt the strings.

C&C server address retrieval from public webpages
Strings from PolyglotDuke are decrypted using two different algorithms. The string is either RC4 encrypted using the CryptDecrypt API where the key is derived from the system directory path with the drive letter removed, or using the custom encryption algorithm. An IDA Python script to decrypt these strings is provided in our GitHub repository.

The C&C server address is retrieved and decoded from various public webpages such as Imgur, ImgBB or Fotolog posts, tweets, Reddit comments, Evernote public notes, etc. Several encrypted public webpage URLs are hardcoded in each sample (from three to six URLs in a single sample) and it will iterate over the hardcoded list of C&C server addresses until it is able to decode a valid C&C URL successfully.

After retrieving the content of one of these webpages, PolyglotDuke parses it to find two delimiter strings and extracts the content between them. The extracted UTF-8 string uses a particular character set within a Unicode block such as Katakana, Cherokee or Kangxi radicals. Any given sample can only decode a C&C URL encoded in one of those charsets. The string is first converted to UTF-16, only the last byte of each codepoint is kept, then a custom mapping is used to transpose this to printable ASCII. The order of the characters of the resulting string is then reversed, resulting in the C&C URL. A script to decrypt the C&C URL, regardless of the Unicode range used, is provided on our GitHub repository.

PolyglotDuke, a multilingual downloader
Katakana is a Japanese syllabary (part of the Japanese writing system), while Cherokee syllabary is used to write Cherokee (which is a Haudenosaunee language), and Kangxi radicals are components of Chinese characters. The use of these character sets from different languages is the reason we named this downloader PolyglotDuke.

Interestingly, the text from the delimiter strings usually makes sense in the context of the fake post. The decoded C&C URL points to a PHP script with which the downloader communicates using GET requests, as described in the next section.

Communication with the C&C server
Once the C&C server URL is decoded, the compromised computer sends HTTP GET requests with arguments using the following format:
GET example.com/name.php?[random_param1]=[random_string1]&[random_param2]=[random_string2]
Only the argument values are relevant here as the argument names are selected randomly from a hardcoded list. This makes the communication between PolyglotDuke and the C&C server difficult to identify because there are no obvious patterns. Additionally, the User-Agent header used to perform the GET requests is a common one.

The GET argument values are randomly generated but the first random string in each request should comply with a constraint based on a specific integer (see below). A string will be randomly regenerated until one complies with the constraints. The digits from the string representation of the MD5 hash of the randomly generated string are summed, and then modulo 5 of this value must match a specific integer.

The communication with the C&C server to retrieve a payload follows this sequence:
• First the communication with the C&C server is checked. The sum of the digits of the MD5 hash of the first argument modulo 5 should be equal to 4. The response of the C&C server is matched with the second random string as it will echo back this string in case of successful communication.
• If the communication with the C&C server is successful, a custom hash from the concatenation of the username and the volume serial number of the disk of the current directory is generated and sent twice. The modulo 5 value of the MD5 hash of the first parameters of these requests should be 0 and 2 respectively.
• In the response to the second request, search for <img src=” and the next “> strings in the last response and extract the image filename between them, if present.
• If a filename was extracted in the preceding step, the file is retrieved into the directory whose name is the unique ID sent twice at the registration step: GET example.com/<Username_VolumeID_Hash>/cuteanimals12.jpg

This sequence continues until a path to a file is provided between the <img src=” and “> strings and the file downloaded.

Interestingly, the root URLs of the C&C server used by PolyglotDuke redirect to domains with similar names hosting legitimate websites. This technique is probably used in order to avoid suspicion when investigating the traffic with the C&C server. For one of the C&C servers, the attackers forgot to add a TLD to the redirected domain.

Payload decryption and execution
A data blob containing encrypted data is appended to the end the downloaded file: this technique allows data to be easily included in a JPEG or PNG image download in a way that means the image remains valid. We couldn’t retrieve any of the files downloaded by PolyglotDuke to confirm this hypothesis but the way the encrypted blob is added to such files in addition to their extension being .jpg or .png lead us to think that they were valid images used to look like legitimate traffic.

To extract the payload from the file downloaded from the C&C server, PolyglotDuke will first decrypt the last eight bytes with RC4 using the same key as the one used for strings decryption. The first four decrypted bytes correspond the offset to the embedded blob relative to the end of the file and the last four bytes provide a value used as integrity check; that value is the same as the first four bytes at the beginning of the blob.

After obtaining the offset to the embedded blob and checking the integrity value, the size of the RC4-encrypted blob is retrieved from immediately afterward. Then, next to the encrypted blob, we find the signed SHA-1 hash of the blob. Before decrypting the blob, the hash signature is checked against an RC4-encoded public key hardcoded in the binary.

This technique ensures that only a payload signed by the operators could be executed on the victim’s machine, since the private key used to sign the hash is needed to generate a valid signature.

After having successfully checked the hash signature of the encrypted blob, it is decrypted using the same key used for the RC4-encrypted strings.

Notice that the same delimiter value is used and checked at various positions of the blob (in the example it is 0x1BD75010). Two of the bytes between the first two delimiters define the action to be taken with the decrypted blob.

The value immediately following the second delimiter is the size of the data, being either a PE or an encrypted configuration, followed by the data itself followed by a third delimiter, the size of the subsequent filename, and finally the filename itself. The correct extension (.dll or .exe) will be appended to the filename of the PE to be written, depending on the executable type.

4.3 RegDuke: a first-stage implant
RegDuke is a first-stage implant that is apparently used only when attackers lose control of the other implants on the same machine. Its purpose is to stay undetected as long as possible to help make sure the operators never lose complete control of any compromised machine.

It is composed of a loader and a payload, the latter being stored encrypted on the disk. Both components are written in .NET. RegDuke persists by using a WMI consumer named MicrosoftOfficeUpdates. It is launched every time a process named WINWORD.EXE is started.

Our analysis is based on the sample with SHA-1 0A5A7DD4AD0F2E50F3577F8D43A4C55DDC1D80CF.

The loader
Between August 2017 and June 2019, we have seen four different main versions of the loader. The first version was not obfuscated and had the encryption key hardcoded in the code. Later versions read the encryption key from the Windows registry and use different types of obfuscation such as control-flow flattening or directly using .NET Reactor, a commercial obfuscator.

The flow of the loader is simple. It reads the encrypted file at either a hardcoded path or at a value extracted from the Windows registry. Then, it decrypts it using a password and a salt either hardcoded in the loader or stored in the Windows registry. The encryption key and the initialization vector are derived from the password and the salt using the technique described in RFC 2898, also known as PBKDF2.

In all the samples we have seen, they use only the three different registry keys listed. It is interesting to note that attackers seem to have put some effort at selecting registry keys and values that might look legitimate.

Finally, the decrypted Windows Executable is loaded using the Assembly.Load method. We only found one payload, but we cannot be certain that others are not deployed in the wild.

The payload: a fileless, Dropbox-controlled backdoor
The payload is a backdoor that resides in memory only, and that uses Dropbox as its C&C server. Its configuration is hardcoded in an internal class. Our analysis is based on the sample with SHA-1 5905C55189C683BC37258AEC28E916C41948CD1C.

We have seen the following clientId values being used: collection_3, collection_4, collection_6, collection_7, collection_8 and collection_99. However, other than collection_4, we were not able to determine the targets for these collections.

The backdoor regularly lists the Dropbox directory corresponding to its clientId and downloads PNG files from it. The downloaded PNG files are valid pictures.

However, the attackers have used steganography to hide data in the pictures. Each pixel is encoded into 24 bits: 8 for red, 8 for green and 8 for blue. The developers use a technique called “Least Significant Bit” to store 8 bits of data in each pixel. This technique has been used previously by other malware such as Gozi. They extract two bits from the red value, three from the green and three from the blue.

The steganographically altered image has almost no visible difference from the original image because the two or three least significant bits have a very limited impact on the color. For the green and blue components of each pixel a maximum of 7/256, and for the red component 3/256 of a fully saturated pixel variation will occur.

Finally, it decrypts the extracted bytes using the AES key hardcoded in the config. The decrypted data can be:
• a Windows executable
• a Windows DLL
• a PowerShell script

We have seen the following executables being dropped by this Dropbox backdoor:
• Several MiniDuke backdoors (see section 4.4)
• Process Explorer, a utility that is part of the SysInternals suite

4.4 MiniDuke backdoor: the second stage
As highlighted in section 3.2, the most recent versions of the MiniDuke backdoor have a lot of code similarities with earlier versions, such as the sample with SHA-1 of 86EC70C27E5346700714DBAE2F10E168A08210E4, described by Kaspersky researchers in 2014. Our analysis is based on the sample with SHA-1 B05CABA461000C6EBD8B237F318577E9BCCD6047, compiled on August 17, 2018.

MiniDuke acts as a second-stage backdoor, which is dropped by one of the two first-stage components described in the sections above.

The most recent samples we are aware of were compiled in June 2019 and show no major changes, except the C&C domain and the use of an invalid (likely transplanted) digital signature. This might be an attempt to bypass some security products.

The backdoor is still written in pure x86 assembly but its size increased a lot – from 20 KB to 200+ KB. This is due to the addition of obfuscation, mainly control-flow flattening. This is a common obfuscation technique that makes it difficult to read the code because every function is split in a switch/case inside a loop.

Some of the Windows API functions are resolved dynamically. The backdoor uses a simple hash function to obfuscate the name of the function it tries to resolve.

The network communication is relatively simple. It can use the GET, POST and PUT HTTP methods to contact the hardcoded C&C server.

In order to blend into the legitimate traffic, the data are prepended with a JPEG header. The resulting images are not valid, but it is very unlikely that anybody will check the validity of all pictures in the network traffic. As the server was down at the time of capture, we were not able to receive a reply, but we believe the reply also contains a JPEG header, as the malware ignores the first bytes of the reply.

In addition to the HTTP protocol, the malware is able to send and receive data over a named pipe. This feature typically allows it to reach machines on the local network that don’t have internet access. One compromised machine, with internet access, will forward commands to other compromised machines through the named pipe.

A similar feature to the named pipe is the HTTP proxy. The malware will listen on a first socket, either on the default port 8080 or on a port specified by the operators. It will also open a second socket with the C&C server. It waits for connections on the first socket and when one is established, it proxies data between the two sockets. Thus, a machine without internet access, or with a firewall that blocks connections to the attackers’ domain, might still be able to reach the C&C through the proxy machine.

Finally, this malware implements thirty-eight different backdoor functions such as:
• Uploading or downloading files
• Creating processes
• Getting system information (hostname, ID, pipename, HTTP method)
• Getting the list of local drives and their type (unk, nrt, rmv, fix, net, cdr, ram, und)
• Reading and writing in the named pipe
• Starting and stopping the proxy feature

4.5 FatDuke: the third stage
FatDuke is the current flagship backdoor of the group and is only deployed on the most interesting machines. It is generally dropped by the MiniDuke backdoor, but we also have seen the operators dropping FatDuke using lateral movement tools such as PsExec.

The operators regularly repack this malware in order to evade detections. The most recent sample of FatDuke we have seen was compiled on May 24, 2019.

We have seen them trying to regain control of a machine multiple times in a few days, each time with a different sample. Their packer, described in a later section, adds a lot of code, leading to large binaries. While the effective code should not be larger than 1MB, we have seen one sample weighing in at 13MB, hence our name for this backdoor component: FatDuke.

In this section, we will use the sample with SHA-1 DB19171B239EF6DE8E83B2926EADC652E74A5AFA for our analysis.

Installation and persistence
During our investigation, we were not able to find a dropper for FatDuke. We believe the operators simply install the backdoor and establish persistence using the standard commands of an earlier stage backdoor.

We also noted that FatDuke generally replaced the second-stage binary, reusing the persistence mechanism already in place.

The persistence we have seen is very standard. They use the registry key HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run and creatd a new value named Canon Gear and value C:\Program Files\Canon\Network ScanGear\Canocpc.exe. This launches the backdoor each time a user logs in.

Configuration
FatDuke has a hardcoded configuration embedded in the executable’s resources.

The configuration data is a JSON object encoded in base64. Once decoded, it reveals much interesting information.

Included in the information contained in the config, we can see:
• The AES key used to encrypt/decrypt the network traffic
• The pipe name and the credentials used to contact another machine on the local network
• The C&C URL
• The time of day when the backdoor is enabled for attacker access
• Cookies that the malware can fetch in the browser’s cookie directory. They are related to cookies used by Google services such as YouTube or Gmail

The operator has the possibility to fetch the configuration from the computer along with usual computer information like username, Windows version, computer name, build, etc.

Finally, it does not seem possible to update this configuration without dropping a new version of the malware.

Backdoor and network
FatDuke can be controlled remotely by the attackers using a custom C&C protocol over HTTP or using named pipes on the local network.

HTTP communications and backdoor commands
In order to blend into the network traffic, FatDuke tries to mimic the user’s traffic by using the same User-Agent as the browser installed on the system. It implements two different techniques to gather this value.

First, it can probe the User-Agent by making an HTTP request on a socket it has just created.
1. It creates a socket listening on localhost:80
2. It accepts any connection
3. It calls ShellExecuteW with open and http://localhost: as argument. This will open the default browser on the URL localhost.
4. The socket replies with a hardcoded HTTP reply:
HTTP/1.1 200 OK
Server: Apache/2.2.14 (Win32)
Content-Type: text/html
Connection: close
<html><script>window.close();</script></html>
This simple JavaScript code will directly close the browser. The window pops up only for a fraction of second but the user also loses focus of the currently active window.
5. In order to extract the User-Agent, FatDuke parses the HTTP request sent by the browser to its socket.
If the previous method did not work, it can check the default browser in the registry key HKCU\Software\Classes\http\shell\open\command. It then selects one of the hardcoded User-Agent strings accordingly.

Next, FatDuke contacts the C&C server, specified in the config, and uses one of the PHP scripts specified in the php_aliases field of the config. It is interesting to note that these filenames are related to the theme of the C&C server domain. For example, they registered the domain westmedicalgroup[.]net, and the aliases list contains filenames such as doctors.php or diagnostics.php.

The requests sent to the C&C server are crafted to look like typical GET requests and once again are related to the script name. For example, the request below uses parameters that you might expect to find on a forum’s website.
/homepage/forum.php?newsid=<RANDOM>&article=<REDACTED>&user=e40a4bc603a74403979716c932f0523a&revision=3&fromcache=0
However, while some fields are randomly generated strings, article and user could be used by the operator to pinpoint the victim. The first keyword, article, is an identifier – a SHA-256 hash of the volume identifier concatenated with MAC addresses found on the target computer. The other keyword, user, probably flags the general configuration that comes with the malware. This value is located in the PE resource section, right before the encoded configuration mentioned in section 4.5.

The reply is an HTML page, with the HTML content copied from a legitimate website such as the BBC. However, if the C&C server wants to send a command to the malware, it will add an additional HTML img tag to the page.

Once it receives this HTML page, the malware uses the two following regexes:
• <img id=”id[0-9]+” src=”([^ “]+)” class=”image-replace”[^>]*>
• <img id=”idd[0-9]+” src=”([^ “]+)” class=”image-replace”[^>]*>

These regexes extract the src attribute value – the URI of the image. If it finds an image, the malware will make another GET request to http(s)://<C&C>/<directory>/<php_script.php>?imageid=<src value>. In our example, it will make a request to http://<C&C>/about/bottom.php?imageid=32d7bcf505ca1af4a38762ff650968ac9cab2ce305cdbf8331d30b.png.

This will return a file. These files masquerade as PNG images in the GET request, but are not valid images. They contain a header of 0x37 bytes, matching one hardcoded in the malware, and a chunk of encrypted data that is base64 encoded. To further the PNG subterfuge, the header contains an incomplete, misplaced and corrupted PNG header, which may be sufficient to avert concern under cursory examination.

The malware then decrypts this data using AES-256 in ECB mode, with the key hardcoded in the config. The result is a command in JSON.

These JSON objects contain a command identifier and the command arguments.

The C&C servers used for FatDuke do not seem to be compromised websites. In order to look legitimate, they register variants of existing domains and redirect the homepage of their C&C server to the homepage of the real domain. As mentioned before, this technique is also used for PolyglotDuke C&C servers.

For example, they registered the domain fairfieldsch[.]org and make it redirect to fairfields.northants.sch.uk, the website of a school in the UK.

We also noticed that they used several C&C servers per targeted organization, but these servers apparently don’t overlap across the victims, ensuring tight compartmentalization.

Local network pivoting
What if the compromised machine doesn’t have access, or has restricted access, to the Internet? The developers implemented a functionality they called PivotingPipeTransport.

It allows the malware to communicate with other malware instances using pipes. In order to connect to a remote machine, it first calls WNetAddConnection2. This function takes the following arguments:
• lpNetResource: the remote machine
• lpPassword: the remote password
• lpUserName: the remote username

These pieces of information are available in the malware configuration under the names:
• pivoting_ip
• pivoting_login
• pivoting_password

Then, it will create a pipe using the name specified in the pivoting_pipe configuration field and use it to communicate with the other malware instance.

Thus, this functionality allows attackers to bypass network restrictions that may be enforced on critical systems. However, they need to steal the credentials of the remote machine first or use organization-level administrative credentials.

Obfuscation
The FatDuke binaries are highly obfuscated. They use three different techniques in order to slow down analysis.

First, they use string stacking for all important strings; this consists of building strings dynamically by pushing each character separately on the stack, rather than using strings from the .data section. They also add some basic operations to the stacking in order to prevent the extraction without emulating the code.

Second, they also add opaque predicates in most of the functions. Opaque predicates are conditions that are always True or always False. They are not part of the code's semantic, but the code is harder to read.

Third, they add junk code and junk strings. Unlike opaque predicates, the code will be executed but it is useless and again is not part of the semantics of the program. For example, the function returns always the same value, which is never used.

The binary contains a huge amount of strings from different projects like Chromium. It might be an attempt to bypass security products, similar to what was posted by SkyLight. These strings are used to fill very large structures (about 1000 fields), probably to hide the few interesting fields used by the malware.

We are not sure whether Dukes’ developers used a commercial obfuscation tool or if they developed their own. However, given their level of sophistication, it would not be surprising if they rely on their own obfuscator.

4.6 LiteDuke: the former third stage
LiteDuke is a third-stage backdoor that was mainly used in 2014-2015. It is not directly linked to Operation Ghost, but we found it on some machines compromised by MiniDuke. We chose to document it mainly because we did not find it described elsewhere. We have dubbed it LiteDuke because it uses SQLite to store information such as its configuration. Our analysis is based on the sample with SHA-1 AF2B46D4371CE632E2669FEA1959EE8AF4EC39CE.

Link with the Dukes
LiteDuke uses the same dropper as PolyglotDuke. It also uses the same encryption scheme, shown in section 3.2, to obfuscate its strings. As we haven’t seen any other threat actor using the same code, we are confident that LiteDuke was indeed part of the Dukes’ arsenal.

Packer
LiteDuke is packed using several layers of encryption and steganography.
1. In the PE resources section, the initial dropper has a GIF picture. The picture is not valid but contains a second dropper.
2. This second executable has a BMP picture in its resources. It uses steganography to hide bytes in the image. Once decoded and decrypted, we have the loader.
3. The loader will decrypt the backdoor code and load it into memory.

Side Story
We also noticed that the attackers left a curious artefact in an older sample (the dropper with SHA-1 7994714FFDD6411A6D64A7A6371DB9C529E70C37). This is the phone number of a mental health specialist in a small city in the state of Indiana in the United States.

Backdoor
The backdoor code only exists in memory as only the loader is written to disk. The loader persists using a Windows shortcut (.lnk file) that is registered in the traditional CurrentVersion\Run registry key.

According to the PE header, the developers did not make use of Visual Studio to compile this backdoor. They used the linker FASM 1.70. FASM (Flat Assembler) is an assembler that can produce Windows or Linux binaries. It reminds us of the MiniDuke backdoor, developed directly in x86 assembly.

The backdoor DLL exports seven functions that have relatively explicit names (CC being Crypto Container):
• SendBin
• LoadFromCC
• SaveToCC
• GetDBHandle
• GetCCFieldSize
• GetCCFieldLn
• DllEntryPoint

Interestingly, the malware apparently attempts to bypass Kaspersky security products by checking if the registry key HKCU\Software\KasperskyLab exists and if so, it waits 30 seconds before executing any additional code. We do not know whether this really bypasses any Kaspersky security products.

The Crypto Container is an SQLite database, stored on the disk in the same directory as the loader, and uses SQLCipher. This SQLite extension encrypts the database using AES-256. The encryption key is the MD5 hash of machine-specific values (such as CPUID, the account name, the BIOS version and the processor name) to prevent decryption if, for example, the database ends up in a public malware repository. The key is not stored anywhere but is re-generated at each execution.

The database contains three different tables, which are created using the following commands:
CREATE TABLE modules (uid INTEGER PRIMARY KEY, version char(255), code blob, config blob, type char(10), md5sum char(32), autorun (INTEGER);
CREATE TABLE objects (uid INTEGER PRIMARY KEY AUTOINCREMENT, name CHAR(255), body blob, type char(10), md5sum char(32));
CREATE TABLE config (uid INTEGER PRIMARY KEY AUTOINCREMENT, agent_id CHAR(128), remote_host CHAR(256), remote_port integer, remote_path char(1024), update_interval integer, server_key CHAR(32), rcv_header CHAR(64));

The configuration default values are hardcoded in the binary. This SQLite table allows the malware operators to update these parameters easily.

Similarly, the modules, which are plug-ins for the backdoor, are stored in the database. Since the database is encrypted, the modules never touch the disk in plaintext and will only be loaded into memory. Unfortunately, we have not yet been able to find any of the plug-ins used by LiteDuke.

One artefact of the development method is the implementation of the backdoor commands. Usually, a backdoor will have a big switch statement to check the command sent by the C&C server against the list of commands implemented in the malware. In the case of LiteDuke, it is a succession of loops: one loop per implemented command.

Each of the 41 different commands has between three and six possible command IDs. The program will loop successively on the list until the ID in the list matches the ID provided by the operator.

Given the large number of different commands, we won’t list them all. Basically, the backdoor can:
• Upload or download files
• Securely delete a file by first writing random data (from a linear congruential generator) to the file
• Update the database (config, modules and objects)
• Create a process
• Get system information (CPUID, BIOS version, account name, etc.)
• Terminate itself

The network part of the backdoor is relatively simple. It uses GET requests to contact either the hardcoded C&C URL or the one stored in the database.

Among the different samples we analyzed, the C&C domains are different, but they always use a script named rcv_get.php. We believe that the C&C domains are compromised servers.

In order to blend into the network traffic, and similar to FatDuke, the malware checks the default browser and chooses its User-Agent request header accordingly. It can also get the proxy configuration from Firefox, in the configuration file prej.js, or from Opera, in the operaprefs.ini file. This information is then used when establishing a connection to the C&C server.

As one can see, some of these User-Agents are custom and they all refer to very old browsers, most of them released in 2011. It is also way less stealthy than with FatDuke’s sniffing of the real User-Agent used by the local browser. This reinforces our hypothesis that this backdoor was used many years ago and is no longer deployed in the wild.

5. CONCLUSION
Operation Ghost shows that the Dukes never stopped their espionage activities. They were in the spotlight after the breach of the Democratic National Committee during the 2016 US presidential elections. However, they then recovered from that media attention and rebuilt most of their toolset.

Using these new tools and previously used techniques, such as leveraging Twitter and steganography, they were able to breach Foreign Affairs Ministries of several European governments.

This campaign also shows that APT threat actors going dark for several years does not mean they have stopped spying. They might pause for a while and re-appear in another form, but they still need to spy to fulfill their mandates.

To help defenders better protect their networks, we will continue to monitor the Dukes’ developments.