近期披露的APT组织攻击活动中，我们发现部分组织频繁使⽤⼀项历史悠久的信息隐藏技术——隐写术。这些隐写术的实现或复杂或简单，但都有效地增加了攻击的隐匿性与强度。

前⾔
 作为有⾼度攻击能⼒的团伙代表，APT组织有时会使⽤⼀些⾮常规的攻击技术。近期披露的APT组织攻击活动中，我们发现部分组织频繁使⽤⼀项历史悠久的信息隐藏技术——隐写术。这些
隐写术的实现或复杂或简单，但都有效地增加了攻击的隐匿性与强度。

关于隐写术
隐写术（Steganography）⼀词来源于特⾥特⽶乌斯的⼀本讲述密码学与隐写术的著作Steganographia，该书书名源于希腊语，意为“隐秘书写”。

计算机领域涉及的隐写术载体⼗分⼴泛，⽂本信息、图像信息、⾳频和视频信息都可以成为隐藏信息的载体，我们只需要将需隐藏的信息拆散并⽤固定的格式覆写⾄信息载体中，就可以实现在

欺骗⼈类感官的同时传递信息。这些隐写术配合⼀定复杂度的加密技术，即可在相当程度上保证端到端信息传递的隐蔽性，因此该技术经常出现在灰⾊、⿊⾊领域以及⽹络攻防对抗当中。

APT组织使⽤的隐写术
海莲花（OceanLutus）与图像隐写
我们先来看⼀下⼤名鼎鼎的海莲花组织在2018年10⽉的⼀次攻击中使⽤的隐写术技术。

该次攻击的原始载荷是⼀个名为mcvsocfg.dll的动态链接库⽂件，该⽂件模仿McAfee旗下同名⽂件的导出表，使⽤⽩利⽤的⽅式将⾃身加载运⾏。当受害者打开同⽬录下的安全程序mcods.exe
时，该dll中的恶意代码被调⽤执⾏。

Dll⽂件包含以下导出表：

导出表中所有函数都执⾏同样的恶意代码，读取system.ini⽂件并以此解密隐写术图像中的信息：

隐写术图像在dll同⽬录下，名为x5j3trra.Png：

阅读关键代码可发现，该程序将png图像每个像素RGB值的低位拼合成⼀个字节，再将所有字节组合为加密字节串：

此处dwARGB值在内存中遵循BGRA的字节排列，因此每个像素的隐藏信息提取过程如下（以图⽚头部像素0xFF4586E2为例）：

以上提取结果为0xB5，即图像的此像素中隐藏了值为0xB5的单字节信息。

通过以上⽅式，程序将隐藏在png图像中的加密字节串提取出来，之后使⽤AES-CBC和异或解密出最终载荷：

该最终载荷为多层shellcode加载器形式的DenesRAT⽊⻢，详细分析可参⻅由伏影实验室发布的《海莲花（APT32）组织 DenesRAT⽊⻢与相关攻击链分析》。

在这次攻击中，海莲花组织使⽤了最常⻅的隐写术⼿法——图⽚像素低位隐写，这样的⼿段⽣成的图像⾜以欺骗⼈类的视觉；再通过有⼀定难度的加密⽅式，使得安全⼈员即使获取到了包含隐
写信息的图像也⽆法还原出攻击载荷，⼤⼤增加了攻击流程的隐匿性。

Dukes（APT29）与图像隐写
同样的⼿段出现在APT组织Dukes的攻击流程中。在最近由ESET披露的攻击活动中，Dukes使⽤的攻击载荷PolyglotDuke与RegDuke在C&C通信阶段使⽤了图像隐写术作为隐匿⼿段。这些载
荷使⽤的隐写⽅式与上⽂所述海莲花隐写术基本相同，在png图像每个像素RGB值的低位中存放了1字节的信息，且完整信息同样是使⽤AES加密的密⽂，唯⼀不同点在于取⽤的RGB像素位与
最终拼接顺序。该隐写⽅式取⽤的RGB通道位置、位数及组合⽅式示例如下：

同时，ESET的报告中展示了以下隐写图像：

由此可以看出，该类隐写技术⼏乎不会对图像的可视性带来影响。

使⽤图像隐写，Dukes的C&C服务器可以向种植了PolyglotDuke或RegDuke后⻔的主机发送可执⾏⽂件载荷。

ScarCruft（APT37）与图像隐写
⽆独有偶，韩国APT组织ScarCruft在今年的攻击活动中也利⽤了隐写术图像。

该攻击事件在19年5⽉被发现，整个攻击过程包括多个阶段与载荷，其中使⽤隐写术的攻击载荷名为fastuserswitchingcompatibility.dll，伪装成Fast User Switching Compatibility服务安装⾄系统
服务中。该伪造服务在启动时会执⾏ServiceMain函数，装载主要恶意代码：

图中所示线程主要功能为从下载服务器下载下⼀阶段载荷，之后解密载荷并注⼊⾄winlogon.exe中执⾏。值得注意的是，该下载载荷和解密载荷的过程使⽤了图⽚隐写，图像名为images.Png:

该png图像在常规数据块IHDR、PLTE、IDAT、IEND以外，末尾还加⼊了⼀个⾃定义的数据块SIGN，与前4字节组成标志位SELFSIGN：

通过该标志位定位加密字符串位置后，程序使⽤xor逻辑进⾏解密，异或键为0x49：

解密后的攻击载荷为ROKRAT后⻔，其主要功能为窃取⽤户主机信息并上传⾄指定云服务中（Box, Dropbox, Pcloud, Yandex）。该后⻔会被植⼊到winlogon.exe进程中。

该次攻击事件中，ScarCruft组织使⽤了图⽚隐写更直接的⼿法，即直接将加密数据植⼊图像数据末尾。该⼿法优点在于可以在同等⼤⼩的图像中塞⼊更多隐藏信息，⽽缺点在于数据整体暴露
在合法⽂件结构以外，容易被静态检测⼿段检测。

⽩⾦（Platinum）与⽂本隐写
卡巴斯基在今年5⽉的报告中提到， APT组织Platinum也在使⽤隐写术传递载荷。

与海莲花和ScarCruft不同，Platinum使⽤了⽂本隐写术。卡巴斯基报告中提到了两种⽂本隐写术⼿法：关键词隐写和空⽩隐写。这两种⽂本隐写⽅式的思路截然相反，关键词隐写将内容隐藏
在可⻅字符中，空⽩隐写则将之隐藏⾄不可⻅部分。

报告中提到的关键词隐写部分如下：

该html⽂件的28⾏到37⾏语句中包含四个属性：bgcolor、align、colspan、rowspan。由于html对属性的顺序不敏感，这些属性的位置可以随意调换，Platinum正是利⽤了这⼀点来传递信息。
简单计算可知，这四个属性组成的四进制数据有24种不同的排列，可指代0⾄0x17的⼗六进制数据，因此⼀⾏携带的隐藏信息量超过了4bit。

空⽩隐写则如下所示：

位于⽂件943~947⾏的隐写内容由空格键（0x20）和制表键（0x9）组成，因此对阅读者不可⻅。由关键词隐写我们可以联想到，该部分的隐写内容是⼆进制数据，事实也正是如此。然⽽，由
于⼆进制数据能够装载的信息很有限，常规数据⼀般需要经过压缩来获得更⼩的⼆进制空间。卡巴斯基报告指出，该处的⼆进制数据是由ICE算法压缩的。

 从Platinum组织使⽤的隐写术中可以发现，隐写术的本质是将⼆进制数据转为其他进制数据并放⼊合适的载体中。因此，隐写术的载体可以是现代计算机⽹络中任何信息载体形式，攻击者是
否使⽤隐写术更多取决于载体是否易于传播以及转换后信息是否⾜够隐蔽。