隐藏在账单下的恶意 —— APT-C-08（蔓灵花）最新攻击活动简报

APT-C-08，又被称“蔓灵花”、 “Bitter”，是一个针对南亚地区展开攻击活动的 APT 组织。近期我们捕获了蔓灵花以“Datails of bill”为由对国外军工企业实施的攻击活动事件，在其中蔓灵花使用了多种新的攻击手法和样本。

1. 恶意Chm文件再升级

2021年10月26日，蔓灵花组织向目标用户发送了一封名为“Details of bill”的邮件。
在附件中携带了包含chm文件的压缩包。chm文件以及包含的文件如下：

在chm文件中将恶意代码分为x、y、z三个按钮，当打开时，会自动按照顺序点击执行，通过rundll32.exe调用RunHTMLApplication执行后续的代码。并将nimc.exe设置为背景音乐的音频文件，在执行后会被释放至”%Temp%”目录。

在按钮x中，通过内嵌的脚本对”%Temp%”目录下的文件进行遍历，查找大小等于51200字节（即nimc.exe的文件大小）的文件，并拷贝至路径”%Appdata%\ctfmon.exe”。

在按钮y中，设置注册表启动项，将路径“%Appdata%\ctfmon.exe”设置为开机启动。

在按钮z中，启动该恶意程序。

ctfmon.exe

程序存在多次路径变更，通过检测自身路径来拷贝自身到指定路径下。

程序启动后，会获取设备上的信息，信息数据拼接格式如下：

计算机名&&user=用户名ZxxZ操作系统版本
拷贝路径完成之后会通过枚举系统快照中的所有进程，来检测运行的包含执行字段的进程名。

检测了进程名中是否包含“MsMp“,”avp”,以及判断路径中是否包含“msvc.”。

根据上述进程判断，在满足条件下进行注册表操作，添加开机启动项，文件的路径是” CSIDL_LOCAL_APPDATA\Updates\update.exe”

其中硬编码在内的字符串都是经加密的，加密算法是与key进行xor计算。

每1s与服务端进行一次交互。

http请求格式：

判断计算机名和用户名是否在接收信息中，如果不在则休眠后再次发送请求。

如果接收消息成功则再次判断进程名中是否有avp，如有则拼接字符串后返回。

然后与 /xnb/dxagt5avbB2.php?txt=%computenameusername% 通信。

如果在与接收消息从第2字节开始比较，如果不是’”’, 则将标志位自增，开始与 /dFFrt3856ByutTs/Dxd2869Vbx/ 交互，将收到的消息按ZxxZ解析。

在临时目录文件夹下创建 /Debug/%cmptnameuname%.exe 文件并写入‘M’以及接收数据内容，并运行此文件。

接 下 来 判 断 进 程 名 中 是 否 包 含 该 文 件 名 的 进 程 ， 如 果 包 含 则 拼 接 名 为 SzxxZfilenameZxxZ，否则拼接为RN_EZxxZfilenameZxxZ

如果次数大于255，则打开复制路径下的文件执行。如果成功执行，则本体休眠2s后退出。

2. 双CVE-2018-0798恶意文档

在2021.10.21， 我们捕获了另一封名为”Bill Details”的邮件。

在邮件附件中包含了一个带有CVE-2018-0798的恶意文档文件，在打开后触发漏洞执行shellcode对后续shellcode进行解密。

而在其后的shellcode中，可以分为两部分，如下图标识所示：

在part1中，通过API “GetComputerNameA”获取了计算机名之后，将其进行了赋值，而实际这一部分在后续并未使用到，且后续代码多处存在nop，我们认为part1是蔓灵花组织在旧有shellcode修改后的残留代码。
在part2中，启动schtasks创建计划任务，计划任务创建完成后如下所示，使用curl从远程服务器下载数据到本地路径“%Public%\music\RdxFactory.exe”。

随后触发第二段公式编辑器漏洞，创建另一个计划任务，每二十分钟启动路径为“%Public%\music\RdxFactory.exe”的程序。

值得一提的是，从curl指令是在windows 10 17063版本加入内置命令行工具，而蔓灵花使用这一工具作为攻击链的一环无疑是针对windows 10操作系统对攻击方式进行的一次优化。

样本组件分析

通过持续跟进，我们捕获了多个蔓灵花样本组件：

（1）Agclient_fn.exe

C#开发的RAT组件
ClientmessageProcessor中进行指令的初始化。

指令名 指令 功能

‘12’ 18 获取磁盘信息

‘13’ 19 遍历文件夹，获取文件信息，并发送到服务器

‘26’ 38 创建列表，将指定ID与指定文件路径相关联，若指定路径的文件存在，重命名该文件

‘27’ 39 存取文件数据

‘28’ 40 移除指令38添加的文件路径信息

‘29’ 41 发送指定文件的数据

‘30’ 48 通过shell，获取命名管道中的数据发送回服务端

‘31’ 49 创建cmd.exe进程，提供shell

‘33’ 51 空操作

指令18 ：

遍历获取磁盘信息，包括盘名，卷标，以及类型，并发送。

指令19：
发送文件夹名包括其子目录

发送目录中的文件信息，包括文件名，最后更改的时间，文件扩展名，文件大小等

指令38：
判断文件存在，将文件重命名后移动。

指令39：
以BinaryWriter的形式存取文件的数据写到buffer中。

指令40：
移除在begin中添加的id作为处理文件结束。

指令41：
发送文件的数据

指令48：
获取管道中的内容回传。

指令49：
创建的cmd.exe作为shell

指令51：
该指令没有操作

（2）snowclnt_nv.exe:

与上述的组件都是RAT，部分指令有所不同。

指令名 指令 功能
‘1‘ 1 获取磁盘信息
‘2‘ 2 遍历目录，获取文件信息
‘3‘ 3 创建列表，将指定ID与指定文件路径相关联，若指定路径的文件存在，则重命名该文件
‘4‘ 4 存取文件数据
‘5‘ 5 移除指令3中添加的文件路径信息
‘11‘ 17 发送文件数据
‘8‘ 8 向shell中传入命令，并将输出数据传至服务器
‘7‘ 7 创建cmd.exe作为shell
‘10‘ 16 刷新与服务端的连接
‘6‘ 6 空操作
‘9‘ 9 空操作
‘12‘ 18 通过shell执行复制自身操作

（3）C RAT组件：

通过注册表获取操作系统版本，并获取用户名，计算机名，并判断进程用户的权限。

设置两个时间触发器与服务端51.255.3.62进行交互，每10s触发一次，作为心跳检测。

创建线程接收服务端的指令

指令 功能

3000 拼接系统信息

3001 获取磁盘信息

3002 遍历文件

3004 分部上传获取文件列表，最大为9048bit

3005 创建文件

3006 写文件

3007 创建文件并向文件中写入数据

3009 读取文件

3012 创建命名管道，创建环境变量中的shell进程，并通过管道发送数据

3013 写文件，并通过命名管道读取文件内容

3015 分部上传shell命令返回的结果，最大为9048bit

3016 终止进程

3017 终止相应的线程

指令3000：

拼接获取的系统信息等，包括计算机名，操作系统名，用户名，当前程序路径最后拼接上NA|8.1.1*，之间的拼接用”|”连接。

指令3001：

遍历磁盘获取磁盘盘符

指令3002:

遍历文件并记录最后访问时间

指令3004：

分部上传获取文件列表，最大为9048

长度小于9084时，将内容拼接到buffer+7之后

大于9084时将数据分开

指令3005：

根据指定的格式创建文件，如果创建不成功则发送q7gf

指令3006：

向指令3005中创建文件的写入数据，并判断是否获取计算机名成功，如果不成功则把buffer置为‘N’。

指令3007：

创建文件，如果创建成功则获取文件的大小并打开文件，如果小于9084，则在buffer+11处记录文件的大小，然后将数据xor加密。

指令3009：

读取指令3008中创建的文件，根据文件的大小组合数据。

指令3012：

创建管道，创建线程然后获取环境变量中的%ComSpec%的内容，创建进程作为shell。

从管道中读取数据，同样以9084作为界限来判断情况，数据均进行了加密处理。

指令3013：

通过写管道写入数据以1024为单位

如果数据的长度为0，则读取管道中的数据，数据均进行了加密处理。

指令3015：

分块处理数据，默认形式为不加密数据。

指令3016：

终止进程

指令3017：

终止对应的进程，如果进程中有文件的handle打开，则同时关闭。

发送数据，根据在数据处理时的标志判断发送的内容

数据加密部分代码

3. 溯源关联分析

通过上面相关组件的分析，我们发现此类RAT与蔓灵花组织所用的RAT程序高度相似，都有使用C#开发的习惯，并且在RAT中的指令与我们之前捕获的高度相似

同样利用Office 组件的漏洞攻击是蔓灵花组织常用的手法，在与C&C服务器交互时使用的拼接信息手法也是蔓灵花组织常用的手法。

在C版本的RAT中我们也是捕获过相似的程序，指令甚至没有发生太大的变化，在图中我们可以看出指令的opcode与之前样本对比并没有发生变化。

结合以上的分析我们认为这是蔓灵花组织的攻击行为。

总结

利用压缩包中的chm脚本作为攻击的出发点是蔓灵花组织常用的手法，在此次的攻击活动中，我们发现与以往对比发生了一些变化，与以前的chm创建计划任务对比，此次将同目录下的PE文件进行复制实现持久化并且伪装成系统文件使得更具有迷惑性。其次在我们捕获的.Net的RAT中，代码结构并未存在大的变更，而是在指令名和指令数据处进行修改。

这一行为与响尾蛇相似，可以看到两者主要变更均在于代码执行的部分，对于后续的远控程序，主要以流量或代码特征绕过作为优化方向。而面对这些层出不穷的攻击手法，我们也需要时刻保持警惕。

附录 IOC

hxxp://helpdesk.autodefragapp.com
hxxp://lltdifslogsvc[.]net
hxxp://vnvccdirectinterface[.]net
51.255.3[.]62: 48152
hxxps://slrpnlcontrlintrface[.]com/nt.php
b9025eca96614a473e204e9e8a873e1d
cb901bbae389a7e919ade64e3a7a4490
7b5739af3ecf05c833bc96dbea0503b0
5dbafaefa3e6c9e9fe82d79a4daa6cb6
398afa51fc74eabf7a2cf8871ceb7642
e10f3172489811ed3ba6f53edce91851
c8c8bbe002e548298ca7bacba0f6b580
2d61c8a200aae9609d1efc528eefd75d